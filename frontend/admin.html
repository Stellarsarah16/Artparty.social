<!DOCTYPE html>
<html>
<head>
    <title>Admin Panel</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 0; padding: 20px; }
        .login { max-width: 400px; margin: 50px auto; padding: 30px; border: 1px solid #ddd; border-radius: 8px; }
        .admin-panel { display: none; }
        .tabs { display: flex; gap: 10px; margin-bottom: 20px; }
        .tab { padding: 10px 20px; background: #f0f0f0; border: none; cursor: pointer; }
        .tab.active { background: #007bff; color: white; }
        .content { padding: 20px; border: 1px solid #ddd; }
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 10px; text-align: left; border-bottom: 1px solid #ddd; }
        th { background: #f8f9fa; }
        .btn { padding: 8px 16px; margin: 5px; border: none; cursor: pointer; }
        .btn-primary { background: #007bff; color: white; }
        .btn-danger { background: #dc3545; color: white; }
        .error { color: red; margin-top: 10px; }
    </style>
</head>
<body>
    <div id="login-form" class="login">
        <h2>Admin Login</h2>
        <input type="text" id="username" placeholder="Username" style="width: 100%; padding: 10px; margin: 10px 0;">
        <input type="password" id="password" placeholder="Password" style="width: 100%; padding: 10px; margin: 10px 0;">
        <button onclick="login()" class="btn btn-primary" style="width: 100%; padding: 10px;">Login</button>
        <div id="login-error" class="error"></div>
    </div>

    <div id="admin-panel" class="admin-panel">
        <h1>Admin Panel</h1>
        <div class="tabs">
            <button class="tab active" onclick="showTab('dashboard')">Dashboard</button>
            <button class="tab" onclick="showTab('users')">Users</button>
            <button class="tab" onclick="showTab('locks')">Tile Locks</button>
            <button class="btn btn-primary" onclick="logout()" style="margin-left: auto;">Logout</button>
        </div>

        <div id="dashboard" class="content">
            <h2>Dashboard</h2>
            <div id="dashboard-content">Loading...</div>
            <button onclick="loadDashboard()" class="btn btn-primary">Refresh</button>
            <button onclick="cleanupLocks()" class="btn btn-danger">Cleanup Expired Locks</button>
        </div>

        <div id="users" class="content" style="display: none;">
            <h2>Users</h2>
            <div id="users-content">Loading...</div>
        </div>

        <div id="locks" class="content" style="display: none;">
            <h2>Tile Locks</h2>
            <div id="locks-content">Loading...</div>
            <button onclick="cleanupLocks()" class="btn btn-danger">Cleanup Expired</button>
        </div>
    </div>

    <script>
        let authToken = localStorage.getItem('adminAuthToken');
        
        if (authToken) {
            showAdminPanel();
        }

        async function login() {
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            const errorDiv = document.getElementById('login-error');
            
            try {
                const response = await fetch('/api/v1/auth/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password })
                });
                
                if (response.ok) {
                    const data = await response.json();
                    if (data.user && (data.user.is_admin || data.user.is_superuser)) {
                        authToken = data.access_token;
                        localStorage.setItem('adminAuthToken', authToken);
                        showAdminPanel();
                    } else {
                        errorDiv.textContent = 'Admin access required';
                    }
                } else {
                    const errorData = await response.json();
                    errorDiv.textContent = errorData.detail || 'Login failed';
                }
            } catch (error) {
                errorDiv.textContent = 'Login failed: ' + error.message;
            }
        }

        function logout() {
            authToken = null;
            localStorage.removeItem('adminAuthToken');
            document.getElementById('login-form').style.display = 'block';
            document.getElementById('admin-panel').style.display = 'none';
        }

        function showAdminPanel() {
            document.getElementById('login-form').style.display = 'none';
            document.getElementById('admin-panel').style.display = 'block';
            loadDashboard();
        }

        function showTab(tabName) {
            document.querySelectorAll('.content').forEach(c => c.style.display = 'none');
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.getElementById(tabName).style.display = 'block';
            event.target.classList.add('active');
            
            if (tabName === 'users') loadUsers();
            if (tabName === 'locks') loadLocks();
        }

        async function loadDashboard() {
            try {
                const response = await fetch('/api/v1/admin/reports/system-overview', {
                    headers: { 'Authorization': 'Bearer ' + authToken }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    document.getElementById('dashboard-content').innerHTML = 
                        '<p>Users: ' + (data.users?.total || 0) + ' (Active: ' + (data.users?.active || 0) + ')</p>' +
                        '<p>Active Locks: ' + (data.locks?.active_locks || 0) + '</p>' +
                        '<p>Expired Locks: ' + (data.locks?.expired_locks || 0) + '</p>' +
                        '<p>System: ' + (data.system_health?.status || 'unknown') + '</p>';
                } else {
                    throw new Error('Failed to load dashboard');
                }
            } catch (error) {
                document.getElementById('dashboard-content').innerHTML = 'Error: ' + error.message;
            }
        }

        async function loadUsers() {
            try {
                const response = await fetch('/api/v1/admin/users', {
                    headers: { 'Authorization': 'Bearer ' + authToken }
                });
                
                if (response.ok) {
                    const users = await response.json();
                    let html = '<table><tr><th>ID</th><th>Username</th><th>Email</th><th>Status</th><th>Admin</th></tr>';
                    users.forEach(user => {
                        html += '<tr><td>' + user.id + '</td><td>' + user.username + '</td><td>' + (user.email || 'N/A') + '</td><td>' + (user.is_active ? 'Active' : 'Inactive') + '</td><td>' + (user.is_superuser ? 'Super' : user.is_admin ? 'Admin' : 'User') + '</td></tr>';
                    });
                    html += '</table>';
                    document.getElementById('users-content').innerHTML = html;
                } else {
                    throw new Error('Failed to load users');
                }
            } catch (error) {
                document.getElementById('users-content').innerHTML = 'Error: ' + error.message;
            }
        }

        async function loadLocks() {
            try {
                const response = await fetch('/api/v1/admin/locks', {
                    headers: { 'Authorization': 'Bearer ' + authToken }
                });
                
                if (response.ok) {
                    const locks = await response.json();
                    let html = '<table><tr><th>Tile ID</th><th>User ID</th><th>Expires At</th><th>Actions</th></tr>';
                    locks.forEach(lock => {
                        html += '<tr><td>' + lock.tile_id + '</td><td>' + lock.user_id + '</td><td>' + new Date(lock.expires_at).toLocaleString() + '</td><td><button onclick="releaseLock(' + lock.tile_id + ')" class="btn btn-danger">Release</button></td></tr>';
                    });
                    html += '</table>';
                    document.getElementById('locks-content').innerHTML = html;
                } else {
                    throw new Error('Failed to load locks');
                }
            } catch (error) {
                document.getElementById('locks-content').innerHTML = 'Error: ' + error.message;
            }
        }

        async function cleanupLocks() {
            try {
                const response = await fetch('/api/v1/admin/locks/cleanup', {
                    method: 'POST',
                    headers: { 'Authorization': 'Bearer ' + authToken }
                });
                
                if (response.ok) {
                    const result = await response.json();
                    alert(result.message);
                    loadDashboard();
                    loadLocks();
                }
            } catch (error) {
                alert('Error: ' + error.message);
            }
        }

        async function releaseLock(tileId) {
            if (!confirm('Release lock on tile ' + tileId + '?')) return;
            
            try {
                const response = await fetch('/api/v1/admin/locks/' + tileId, {
                    method: 'DELETE',
                    headers: { 'Authorization': 'Bearer ' + authToken }
                });
                
                if (response.ok) {
                    const result = await response.json();
                    alert(result.message);
                    loadLocks();
                }
            } catch (error) {
                alert('Error: ' + error.message);
            }
        }
    </script>
</body>
</html>
